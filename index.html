<!DOCTYPE html>
<html lang="en" style="font-size:1.9vh;">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Blood for Booty</title>
	<script src="https://kit.fontawesome.com/0422dde105.js" crossorigin="anonymous"></script>
	<link rel="icon" type="image/x-icon" href="favicon.ico">
	<style>
		* {
			box-sizing: border-box;
			-ms-overflow-style: none;
			scrollbar-width: none;
		}
		::-webkit-scrollbar {
			display: none;
		}
		button {
			background-color: rgba(50,0,0,.8);
			color: moccasin;
			font-size: inherit;
			font-family: inherit;
			border: none;
			padding: .3em .5em;
			cursor: pointer;
			min-width: 2rem;
		}
		button:disabled {
			opacity: .5;
			cursor: not-allowed;
		}
		input {
			border-width: .1rem;
			padding: .2rem;
			color: inherit;
			font-family: inherit;
			background-color: papayawhip;
		}
		input.number-input {
			border-left-width: 0;
			border-right-width: 0;
			font-size: 1rem;
			width: 3rem;
			text-align: center;
		}
		#pirate-name-changer > input {
			font-size: inherit;
			width: 8rem;
		}
		.port-action {
			margin: .5rem;
			border: .1rem solid;
			padding: 1rem .25rem;
			width: 15rem;
		}
		#debug-options i {
			cursor: pointer;
			margin: 0 .25em;
		}
		div:has(> .selection-check):hover .selection-check {
			opacity: .5!important;
		}
		@font-face {
			font-family: Lugrasimo;
			src: url("Lugrasimo/Lugrasimo-Regular.ttf") format("truetype");
			font-weight: normal;
			font-size-adjust: 50%;
		}
	</style>
</head>
<body style="margin:0; height:100vh; display:flex; flex-direction:column; font-family:Lugrasimo,cursive; color:rgba(50,0,0,.8);">
<div style="background-color:maroon; color:white; padding:1rem; font-size:1.2rem; cursor:default; display:flex;">
	<span>
		<span style="margin-right:1rem;"><i class="fas fa-beer"></i> <span id="grog">0</span></span>
		<span style="margin-right:1rem;">
			<i class="fas fa-coins"></i> <span id="booty">0</span>
			<span id="devils-fist-icon" style="display:none;">+ <i class="far fa-gem"></i><span id="devils-fist-count"></span></span>
		</span>
		<span id="stash" style="margin-right:1rem; display:none;"><i class="fas fa-piggy-bank"></i><span id="stashed-booty">0</span></span>
		<span style="margin-right:1rem;"><i class="far fa-compass"></i> <span id="heading">Island</span></span>
	</span>
	<span id="debug-options" style="display:none; margin-left:auto;">
		<i id="debug-enabled" class="fas fa-bug" onclick="setDebug(false)"></i>
		<i id="fast-forward" class="fas fa-fast-forward" onclick="toggleFastForward()"></i>
		<i id="choose-rolls" class="fas fa-list-alt" onclick="toggleChooseRolls()"></i>
		<i id="auto" class="fas fa-robot" onclick="toggleAutoPlay()"></i>
	</span>
	<span id="time" style="margin-left:auto;">
		<i id="time-pause" class="fas fa-pause" style="display:none;" onclick="pause()"></i>
		<i id="time-play" class="fas fa-play" onclick="play()"></i>
		<i id="time-step" class="fas fa-step-forward" style="margin-left:.5rem;"></i>
	</span>
</div>
<div id="page-body" style="height:0; flex-grow:1; display:flex; position:relative">
	<div id="log-holder" style="padding-bottom:2rem; width:30rem; height:100%; background-color:tan;">
		<div id="log" style="max-height:100%; padding:0 1rem; overflow:auto;"></div>
	</div>
	<div id="main" style="position:relative; height:100%; width:0; flex-grow:1; text-align:center; top:0;">
		<div id="watermark" style="font-size:20rem; position:absolute; width:100%; height:100%; display:none; background-color:moccasin;">
			<i class="fas fa-skull-crossbones" style="opacity:.5;"></i>
		</div>
		<div id="port-interface" style="display:none; padding:2rem; font-size:1.4rem; height:100%; overflow:auto; background-color:moccasin;">
			<div>Port Actions</div>
			<div style="display:flex; flex-wrap:wrap; justify-content:center; font-size:1rem;">
				<div class="port-action">
					<div id="grog-purchase" style="margin-bottom:1rem;">
						Buy Grog for <span id="grog-price">1</span> Booty each
					</div>
					<button id="devils-fist-buy-grog" style="margin-top:1rem; display:none;" onclick="devilsFistForGrog()">
						Buy 50 with Devil’s Fist
					</button>
				</div>
				<div class="port-action">
					<div>Booty stash</div>
					<div id="stash-inputs" style="text-align:left; display:inline-block;"></div>
				</div>
				<div class="port-action">
					<div>Recruit new crew member for 1 Booty and 1 Grog</div>
					<button id="recruit-button" onclick="recruitPirateButtonPressed(event)" style="margin-top:1rem;">Recruit</button>
				</div>
				<div class="port-action">
					<div>Buy mansion for 300 Booty (thereby winning the game)</div>
					<button id="win-button" onclick="win()" style="margin-top:1rem;" disabled="true">Win</button>
				</div>
			</div>
			<button id="finished-port-button" style="margin-top:1rem;">Shove Off</button>
		</div>
		<div id="chooser" style="display:none; height:100%; width:100%; background-color:moccasin; justify-content:center;">
			<div style="max-width:30rem; width:100%; height:100%; display:flex; flex-direction:column; padding:2rem; font-size:1.4rem;">
				<div id="prompt">Prompt</div>
				<div style="font-size:1.2rem; padding:2rem 0 1rem; height:0; flex-grow:1; max-height:25rem;">
					<div id="description"></div>
					<div id="options" style="height:100%; display:flex; flex-direction:column; flex-wrap:wrap;"></div>
				</div>
				<button id="continue-button">Continue</button>
			</div>
		</div>
		<div id="job-interface" style="display:none; height:100%; width:100%; justify-content:center; background-color:moccasin;">
			<div style="display:flex; height:100%; width:100%; max-width:35rem; flex-direction:column; padding:2rem .5rem; font-size:1.4rem;">
				<div>Assign Jobs</div>
				<div id="assign-instructions" style="font-size:.85rem; opacity:.6; margin:.4rem;">
					<span>Drag & drop to add pirate to work area.</span>
					<span>Tap a pirate’s name to move them to a new job assignment.</span>
				</div>
				<div id="job-area-holder" style="
					display:flex; justify-content:space-between;
					height:0; flex-grow:1; font-size:1rem;
				"></div>
				<div id="scrapper-warning" style="font-size:.85rem; opacity:.6;">* Scrappers may start fights which prevent pirates from working</div>
				<button id="finished-assignment-button" style="margin-top:.6rem;">Continue</button>
			</div>
		</div>
		<div id="pirate-view" style="position:absolute; top:0; height:100%; width:100%; display:none; flex-direction:column; background-color:moccasin; padding:1rem;">
			<div style="font-size:2rem; padding-bottom:1rem;">
				<span id="main-pirate-name">
					<span id="pirate-name">Pirate</span>
				</span>
				<span id="pirate-name-changer" style="font-size:1rem; display:none;">
					<input id="nickname-input" type="text" placeholder="Adjective" />
					<input id="name-input" type="text" placeholder="Name"/>
					<span style="margin:0 .25rem;">the</span>
					<input id="noun-input" type="text" placeholder="Noun" />
					<span style="margin:0 .25rem;">of</span>
					<input id="location-input" type="text" placeholder="Location" />
				</span>
			</div>
			<div id="pirate-profile" style="display:inline-flex; justify-content:center; height:0; flex-grow:1; margin-bottom:1rem;">
				<div style="background-color:tan; padding:1rem; flex-basis:40%;">
					<object id="pirate-man-svg" type="image/svg+xml" data="pirate-man.svg" style="height:100%; margin:auto; max-width:100%; opacity:0; display:none;">pirate graphic</object>
					<object id="pirate-lady-svg" type="image/svg+xml" data="pirate-lady.svg" style="height:100%; margin:auto; max-width:100%; opacity:0; display:none;">pirate graphic</object>
				</div>
				<div style="width:1rem; height:1rem;"><!-- spacer --></div>
				<div style="flex-basis:0; flex-grow:1; font-size:1.4rem; display:flex; flex-direction:column;">
					<div id="attribute-list" style="text-align:left; height:0; flex-grow:1; overflow:auto; padding:0 1rem; border:.1rem solid;"></div>
					<button id="pirate-view-done" style="margin-top:1rem;" onclick="updatePirateView(null)">Back</button>
				</div>
			</div>
		</div>
		<div id="ship-view" style="
			position:absolute; top:0; height:100%; width:100%;
			display:none; flex-direction:column; align-items:center;
			background-color:moccasin; padding:2rem; font-size:1.4rem;
		">
			<div id="ship-flag-holder" style="height:0; width:100%; max-width:30rem; flex-grow:1; overflow:auto; text-align:left; border:0.1rem solid; padding:1rem;"></div>
			<div style="margin-top:1rem;">
				<button onclick="updateShipView(false)">Back</button>
			</div>
		</div>
		<div id="memorial" style="
			position:absolute; top:0; height:100%; width:100%;
			display:none; flex-direction:column; align-items:center;
			background-color:moccasin; padding:2rem; font-size:1.4rem;
		">
			<div id="memorialized-pirate-holder" style="height:0; width:100%; max-width:30rem; flex-grow:1; overflow:auto; text-align:left; border:0.1rem solid; padding:1rem;"></div>
			<div style="margin-top:1rem;">
				<button onclick="updateMemorial(false)">Back</button>
			</div>
		</div>
		<div id="splash-screen" style="font-size:2rem; height:100%; width:100%; background-color:moccasin; position:absolute; padding:4rem 1rem;">
			<div style="font-size:4rem;">Blood for Booty</div>
			<button style="width:25rem; max-width:100%; margin:1rem 0" onclick="newGame()">Start New Game</button>
			<br/>
			<button id="load-button" style="width:25rem; max-width:100%; display:none;" onclick="load()">Load Game</button>
		</div>
	</div>
</div>
<div style="display:flex; height:11.65rem; width:100vw; background-color:#262626; color:white;">
	<div style="overflow-x:auto; width:0; flex-grow:1;">
		<div id="crew" style="display:inline-flex; padding:1rem;"></div>
	</div>
	<div style="padding:1rem; font-size:1.4rem; text-align:center; display:flex; flex-direction:column; background-color:#333;">
		<i class="fas fa-anchor" style="cursor:pointer; margin-bottom:1rem;" title="View Ship" onclick="updateShipView(true)"></i>
		<i class="fas fa-skull-crossbones" style="cursor:pointer; margin-bottom:auto;" title="View Memorial" onclick="updateMemorial(true)"></i>
		<i id="autosave" class="fas fa-save" title="Auto-save" onclick="toggleAutoSave()"></i>
	</div>
</div>

<script src="names-and-hairstyles.js"></script>
<script src="gameplay.js"></script>
<script src="misc-tables.js"></script>
<script src="crew-events.js"></script>
<script src="sea-encounters.js"></script>
<script src="island-exploration.js"></script>
<script src="port-happenings.js"></script>
<script>
let DEBUG_MODE = false;
let AUTO = false;
let LOG_SPEED = 1600;
let CHOOSE_ROLLS = false;

function inflate(html) {
	var template = document.createElement('template');
	html = html.trim();
	template.innerHTML = html;
	return template.content.firstChild;
}

function clear(el) {
	while(el.firstChild) {
		el.removeChild(el.firstChild);
	}
}

function setDebug(enabled) {
	DEBUG_MODE = enabled;
	if(enabled) {
		localStorage.setItem('blood4booty-debug', JSON.stringify({auto:AUTO, speed:LOG_SPEED, chooseRolls:CHOOSE_ROLLS}));
	} else {
		localStorage.removeItem('blood4booty-debug');
		AUTO = false;
		LOG_SPEED = 1600;
		CHOOSE_ROLLS = false;
	}
	updateDebugMenu();
}

function toggleFastForward() {
	if(LOG_SPEED == 1600) {
		LOG_SPEED = 500;
	} else {
		LOG_SPEED = 1600;
	}
	updateDebugMenu();
}

function toggleChooseRolls() {
	CHOOSE_ROLLS = !CHOOSE_ROLLS;
	updateDebugMenu();
}

function toggleAutoPlay() {
	AUTO = !AUTO;
	updateDebugMenu();
}

function updateDebugMenu() {
	document.getElementById('debug-options').style.display = DEBUG_MODE ? 'inline' : 'none';
	document.getElementById('fast-forward').style.opacity = LOG_SPEED == 1600 ? .5 : 1;
	document.getElementById('choose-rolls').style.opacity = CHOOSE_ROLLS ? 1 : .5;
	document.getElementById('auto').style.opacity = AUTO ? 1 : .5;
}

function toggleAutoSave() {
	if(autoSave === undefined) {
		return;
	}
	autoSave = !autoSave;
	let autoSaveIcon = document.getElementById('autosave');
	autoSaveIcon.style.color = autoSave ? '#b00' : 'white';
}

async function recruitPirateButtonPressed(event) {
	event.target.disabled = true;
	event.target.blood4booty = { inProgress:true };
	let recruited = await recruitPirate();
	if(recruited) {
		switchInterface('port');
	}
	event.target.blood4booty.inProgress = false;
	updatePort();
}

function updateNumberSelect(element) {
	let limits = element.blood4booty.limits;
	let minusButton = element.getElementsByClassName('minus-button')[0];
	let addButton = element.getElementsByClassName('plus-button')[0];
	let confirmButton = element.getElementsByClassName('confirm-button')[0];
	let input = element.getElementsByClassName('number-input')[0];
	let val = parseInt(input.value);
	confirmButton.disabled = val < limits.min || val > limits.max;
	minusButton.disabled = val <= limits.min;
	addButton.disabled = val >= limits.max;
}

function prepareNumberSelect(id, confirmText, listener) {
	let element = inflate(`
		<div id="${id}">
			<div style="display:inline-flex;">
				<button class="minus-button">-</button>
				<input class="number-input" type="text" value="0" />
				<button class="plus-button">+</button>
			</div>
			<button class="confirm-button">${confirmText}</button>
		</div>
	`);
	element.blood4booty = {};
	element.blood4booty.limits = { min:0, max:0 };
	let buttons = [ element.getElementsByClassName('minus-button')[0], element.getElementsByClassName('plus-button')[0] ];
	let confirmButton = element.getElementsByClassName('confirm-button')[0];
	let input = element.getElementsByClassName('number-input')[0];
	input.addEventListener('input', event => {
		input.value = input.value.replaceAll(/[^0-9]/g, '');
		let val = parseInt(input.value);
		updateNumberSelect(element);
	});
	buttons.forEach((button, i) => {
		button.addEventListener('click', () => {
			let val = parseInt(input.value) + (i == 0 ? -1 : 1);
			input.value = val;
			updateNumberSelect(element);
		});
	});
	confirmButton.addEventListener('click', () => {
		let limits = element.blood4booty.limits;
		let val = parseInt(input.value);
		if(val <= limits.max && val >= limits.min) {
			listener(val);
			input.value = '0';
		}
	});
	return element;
}

function getDynamicFontSize(text) {
	return (Math.min(1, 5 / text.length) * .4 + .6)+'rem';
}

function updateJobLists(selectedCrew) {
	let instructions = document.getElementById('assign-instructions');
	let shownInstructions = instructions.children[0];
	let hiddenInstructions = instructions.children[1];
	if(mobileView) {
		shownInstructions = instructions.children[1];
		hiddenInstructions = instructions.children[0];
	}
	shownInstructions.style.display = 'inline';
	hiddenInstructions.style.display = 'none';
	let areas = {
		unassigned: document.getElementById('unassigned-area'),
		helm: document.getElementById('helm-area'),
		deck: document.getElementById('deck-area'),
		sails: document.getElementById('sails-area'),
	};
	Object.values(areas).forEach(clear);
	let team = {
		helm: crew.filter(p => p.job == 'helm'),
		deck: crew.filter(p => p.job == 'deck'),
		sails: crew.filter(p => p.job == 'sails'),
	};
	[...crew].sort((a,b) => a.lastMoved - b.lastMoved).forEach(pirate => {
		let jobId = pirate.job || 'unassigned';
		let jobIndex = jobs.findIndex(j => j.id == jobId);
		let nonWorking = cannotWork(pirate, pirate.job ? team[pirate.job] : []);
		let name = getPirateName(pirate);
		let footnote = nonWorking ?? (pirate.captain && filterWorkers(team.helm).length < 2 ? 'Captain will go mad without company' : '')
		let listItem = inflate(`
			<div
				draggable="${pirate.captain ? 'false' : 'true'}"
				style="
					user-select: none;
					cursor: ${pirate.captain ? 'not-allowed' : 'move'};
					${nonWorking ? 'opacity: .75;' : ''}
					background-color: #222;
					color: white;
					padding: .25rem;
					margin-bottom: .5rem;
					min-height: 1.9rem;
				"
			>
				<div style="display:flex; justify-content:center; flex-wrap:wrap;">
					<div style="font-size: ${getDynamicFontSize(name)};">${name}</div>
					<div>${hasAttribute(pirate, flaw.scrapper) ? `<i class="far fa-hand-rock" style="margin-left:.4rem;"></i>` : ''}</div>
				</div>
				${footnote ? `<div style="font-size:.6rem; margin-top:.3rem; color:crimson;">* ${footnote}</div>` : ''}
				${pirate == selectedCrew ? `
					<div style="display:flex; justify-content:space-between; align-items:center;">
						<div class="move-crew-left">
							${jobIndex > 0 ? `
								<i class="fas fa-arrow-left"></i>
							` : ''}
						</div>
						<div style="font-size:.6rem;">Move</div>
						<div class="move-crew-right">
							${jobIndex < jobs.length-1 ? `
								<i class="fas fa-arrow-right"></i>
							` : ''}
						</div>
					</div>
				` : ''}
			</div>
		`);
		areas[jobId].appendChild(listItem);
		if(mobileView && !pirate.captain) {
			if(pirate != selectedCrew) {
				listItem.addEventListener('click', () => updateJobLists(pirate));
			} else {
				listItem.scrollIntoView({ behavior: "smooth", block: "end" });
			}
			let moveButtonLeft = listItem.getElementsByClassName('move-crew-left')[0];
			let moveButtonRight = listItem.getElementsByClassName('move-crew-right')[0];
			if(moveButtonLeft) {
				moveButtonLeft.addEventListener('click', () => assignPirateToJob(pirate, jobs[jobIndex - 1]));
			}
			if(moveButtonRight) {
				moveButtonRight.addEventListener('click', () => assignPirateToJob(pirate, jobs[jobIndex + 1]));
			}
		}
		listItem.addEventListener('dragstart', ev => {
			ev.dataTransfer.setData('text/plain', crew.indexOf(pirate).toString());
			ev.dataTransfer.dropEffect = 'move';
		});
	});
	let jobSuccessChanceData = [
		{ el: document.getElementById('helm-success-chance'), workers: filterWorkers(crew.filter(w => w.job == 'helm')) },
		{ el: document.getElementById('deck-success-chance'), workers: filterWorkers(crew.filter(w => w.job == 'deck')) },
		{ el: document.getElementById('sails-success-chance'), workers: filterWorkers(crew.filter(w => w.job == 'sails')) },
	];
	jobSuccessChanceData[0].chance = jobSuccessChanceData[0].workers.some(w => w.captain) ? 1 : .5;
	for(let i=1; i<3; i++) {
		let data = jobSuccessChanceData[i];
		data.chance = Math.min(5, 1 + data.workers.length) / 6;
	}
	let anyScrappers = false;
	for(let data of jobSuccessChanceData) {
		let hasScrappers = data.workers.some(w => hasAttribute(w, flaw.scrapper));
		if(hasScrappers) {
			anyScrappers = true;
		}
		data.el.textContent = `${Math.round(100*data.chance)}%${hasScrappers ? ' *' : ''}`;
	}
	document.getElementById('scrapper-warning').style.display = anyScrappers ? 'block' : 'none';
}

function assignPirateToJob(pirate, job) {
	let newJob = job.id == 'unassigned' ? null : job.id;
	if(pirate.job != newJob) {
		pirate.job = newJob;
		pirate.lastMoved = Date.now();
		updateJobLists(mobileView ? pirate : null);
	}
}

function updateCrewList() {
	let holder = document.getElementById('crew');
	// remove excess pirates from list
	while(holder.children.length > crew.length) {
		holder.removeChild(holder.children[holder.children.length-1]);
	}
	for(let i=0; i<crew.length; i++) {
		let pirate = crew[i];
		let element = holder.children[i]; // try to re-use existing elements where possible
		let nameText = getPirateName(pirate);
		if(element) {
			let nameEl = element.getElementsByClassName('name')[0];
			nameEl.textContent = nameText;
			nameEl.style.fontSize = getDynamicFontSize(nameText);
			element.removeChild(element.getElementsByClassName('overlay')[0]);
			let killButton = element.getElementsByClassName('kill-button');
			if(killButton.length) {
				element.removeChild(killButton[0]);
			}
		} else {
			// create new element if there aren't enough existing ones
			let svgFile = `pirate-${pirate.female ? 'lady' : 'man'}.svg`;
			element = inflate(`
				<div style="position:relative; text-align:center; width:7rem;">
					<object class="graphic" type="image/svg+xml" data="${svgFile}" style="display:inline-block; height:6rem; opacity:0;">pirate graphic</object>
					<div class="name" style="font-size:${getDynamicFontSize(nameText)};">${nameText}</div>
				</div>
			`);
			holder.appendChild(element);
			window.setTimeout(() => element.scrollIntoView({ behavior: "smooth", block: "end" }), 10);
		}
		// clickable overlay — element itself not clickable on svg part, for some reason
		let overlay = inflate(`<div class="overlay" style="position:absolute; top:0; left:0; width:100%; height:100%; cursor:pointer;"></div>`);
		element.appendChild(overlay);
		overlay.addEventListener('click', () => updatePirateView(pirate));
		// update graphic
		let graphic = element.getElementsByClassName('graphic')[0];
		updatePirateEl(pirate, graphic);
		// if there is a killer in the crew, add the kill button
		let killers = filterByAttr(crew, legend.killer);
		if(paused && killers.length) {
			let killButton = inflate(`
				<i class="fas fa-crosshairs kill-button"
					style="font-size:2rem; position:absolute; top:0; right:0; color:#b00; cursor:pointer;"
				></i>
			`);
			element.appendChild(killButton);
			killButton.addEventListener('click', () => {
				kill(pirate, `was shot by ${getPirateName(killers[0])}`, true);
				updateCrewList();
			});
		}
	}
}

function updateShipView(shown) {
	if(typeof shipWeeklyFlags == 'undefined') {
		return;
	}
	document.getElementById('ship-view').style.display = shown ? 'flex' : 'none';
	if(!shown) {
		return;
	}
	let view = document.getElementById('ship-flag-holder');
	clear(view);
	let items = [];
	shipWeeklyFlags.forEach(k => items.push(shipFlagText[k]));
	shipVoyageFlags.forEach(k => items.push(shipFlagText[k]));
	shipPermanentFlags.forEach(k => items.push(shipFlagText[k]));
	items = items.filter(i => i);
	if(items.length == 0) {
		view.textContent = 'The ship is in good working order.';
		view.style.textAlign = 'center';
	} else {
		addListItems(view, items);
		view.style.textAlign = 'left';
	}
}

function updateMemorial(shown) {
	if(typeof pirates == 'undefined') {
		return;
	}
	document.getElementById('memorial').style.display = shown ? 'flex' : 'none';
	if(!shown) {
		return;
	}
	let view = document.getElementById('memorialized-pirate-holder');
	clear(view);
	let items = pirates.filter(p => !crew.includes(p)).sort((a,b) => a.timeOfDeath - b.timeOfDeath).map(p => ({
		name: getPirateName(p), description: p.causeOfDeath, iconClass: p.alive ? 'fas fa-question' : 'fas fa-skull-crossbones'
	}));
	if(items.length == 0) {
		view.textContent = 'No pirates have left our crew.';
		view.style.textAlign = 'center';
	} else {
		addListItems(view, items);
		view.style.textAlign = 'left';
	}

}

function updatePirateView(pirate) {
	document.getElementById('pirate-view').style.display = pirate ? 'flex' : 'none';
	if(pirate == null) {
		updateNameChanger(null);
		return;
	}
	// name changer
	let iconId = 'name-change-icon';
	let nameHolder = document.getElementById('main-pirate-name');
	let existingIcon = document.getElementById(iconId);
	if(existingIcon) {
		nameHolder.removeChild(existingIcon);
	}
	let editNameIcon = inflate(`<i id="${iconId}" class="fas fa-feather-alt" style="cursor:pointer;"></i>`);
	nameHolder.appendChild(editNameIcon);
	editNameIcon.addEventListener('click', () => updateNameChanger(pirate));
	if(pirate.permanentFlags.has('name-change')) {
		updateNameChanger(pirate, true);
	}
	// portrait
	let portrait = document.getElementById('pirate-man-svg');
	let hiddenPortrait = document.getElementById('pirate-lady-svg');
	if(pirate.female) {
		let ladyPortrait = hiddenPortrait;
		hiddenPortrait = portrait;
		portrait = ladyPortrait;
	}
	portrait.style.display = 'block';
	hiddenPortrait.style.display = 'none';
	updatePirateEl(pirate, portrait);
	document.getElementById('pirate-name').textContent = getPirateName(pirate);
	// attribute list
	let list = document.getElementById('attribute-list');
	clear(list);
	[ 'Legend', 'Skills', 'Flaws', 'Features', 'Other' ].forEach((title, i) => {
		let items = [];
		if(i < 4) {
			switch(i) {
				case(0) :
					items = pirate.attributes.filter(attr => attributeIsLegend(attr));
					break;
				case(1) :
					items = pirate.attributes.filter(attr => attributeIsSkill(attr));
					break;
				case(2) :
					items = pirate.attributes.filter(attr => attributeIsFlaw(attr));
					break;
				case(3) :
					items = pirate.attributes.filter(attr => attributeIsFeature(attr));
					break;
			}
		} else {
			let flags = [];
			pirate.weeklyFlags.forEach(k => flags.push(pirateFlagText[k]));
			pirate.voyageFlags.forEach(k => flags.push(pirateFlagText[k]));
			pirate.permanentFlags.forEach(k => flags.push(pirateFlagText[k]));
			items = flags.filter(i => i);
		}
		if(items.length) {
			list.appendChild(inflate(`<div style="text-align:center;">${title}</div>`));
			let ul = inflate(`<div style="margin:0 0 1rem 0;"></div>`);
			list.appendChild(ul);
			addListItems(ul, items);
		}
	});
	if(!list.children.length) {
		list.appendChild(inflate('<div style="text-align:center; padding-top:1rem;">There is nothing notable about this pirate.</div>'));
	}
}

async function waitForPirateView() {
	if(AUTO) {
		return new Promise(res => res());
	}
	let button = document.getElementById('pirate-view-done');
	return new Promise((resolve, reject) => {
		let listenerName = 'click';
		let listener = event => {
			button.removeEventListener(listenerName, listener);
			resolve();
		};
		button.addEventListener(listenerName, listener);
	});
}

function updateNameChanger(pirate, withExtraOptions=false) {
	let changer = document.getElementById('pirate-name-changer');
	let mainDisplay = document.getElementById('main-pirate-name');
	changer.style.display = pirate ? 'inline' : 'none';
	mainDisplay.style.display = pirate ? 'none' : 'inline';
	if(!pirate) {
		return;
	}
	for(let el of changer.children) {
		el.style.display = withExtraOptions ? 'inline' : 'none';
	}
	let input = document.getElementById('name-input');
	input.style.display = 'inline';
	input.value = pirate.name;
	let nicknameInput = document.getElementById('nickname-input');
	// button
	let buttonId = 'save-pirate-name';
	let existingButton = document.getElementById(buttonId);
	if(existingButton) {
		changer.removeChild(existingButton);
	}
	let button = inflate(`<button id="${buttonId}">Save</button>`);
	changer.appendChild(button);
	button.addEventListener('click', () => {
		let newName = input.value;
		if(newName) {
			pirate.name = newName;
			input.value = '';
			if(withExtraOptions) {
				let newNickname = nicknameInput.value;
				nicknameInput.value = '';
				if(newNickname) {
					pirate.nickname = newNickname;
				}
				let nounInput = document.getElementById('noun-input');
				let locationInput = document.getElementById('location-input');
				let noun = nounInput.value;
				let location = locationInput.value;
				nounInput.value = '';
				locationInput.value = '';
				let appellationBits = [];
				if(noun) {
					appellationBits.push(noun);
				}
				if(location) {
					appellationBits.push(`of ${location}`);
				}
				if(appellationBits.length) {
					pirate.appellation = appellationBits.join(' ');
				}
				
			}
			pirate.permanentFlags.delete('name-change');
			updatePirateView(pirate);
			updateCrewList();
			updateNameChanger(null);
		}
	});
}

function addListItems(container, items) {
	for(let item of items) {
		container.appendChild(inflate(`
			<div style="display:flex; margin-bottom:.5rem;">
				<i class="${item.iconClass || 'fas fa-skull'}" style="margin:.1rem .5rem 0 0;"></i>
				<span style="line-height:1.5rem; font-size:1.25rem;">${item.name} - <span style="font-style:italic; font-size:1rem; opacity:.7;">${item.description}</span></span>
			</div>
		`));
	}
}

function setSvgElVisibility(el, visible) {
	el.style.display = visible ? 'inline' : 'none';
}

function updatePirateEl(pirate, graphic) {
	graphic.blood4booty = { pirate: pirate };
	if(graphic.style.opacity == 1) { // if opacity is 1, that means the svg has loaded, so we can just update it
		let targetSvg = `pirate-${pirate.female ? 'lady' : 'man'}.svg`;
		let svg = graphic.data.split('/').pop();
		if(svg != targetSvg) {
			graphic.setAttribute('data', targetSvg);
			graphic.style.opacity = 0;
		} else {
			updatePirateSvg(pirate, graphic.contentDocument);
		}
	} else { // otherwise, we need to wait for the svg to load first
		graphic.addEventListener('load', event => {
			let pirateToRender = event.target.blood4booty.pirate;
			updatePirateSvg(pirateToRender, event.target.contentDocument);
			graphic.style.opacity = 1;
		}, false);
	}
}

function updatePirateSvg(pirate, el) {
	let elementIdAttributePairs = [
		['sabre', skill.swashbucklin],
		['hat', skill.swaggerin],
		['treasure', skill.stealin],
		['pistol', skill.shootin],
		['parrot', feature.parrot],
		['single-tooth', feature.toothless],
		['eyepatch', feature.eyepatch],
		['beard', feature.beard],
		['earrings', feature.beard],
		['peg-leg', feature.pegLeg],
		['hook', feature.hook],
		['left-hook', feature.leftHook],
		['tattoos', feature.tattoos],
		['monkey', feature.monkey],
		['sick-bubbles', flaw.seasick],
		['drunk-blush', flaw.swigger],
		['nose-dirt', flaw.scummy],
		['face-dirt', flaw.scummy],
		['arm-dirt', flaw.scummy],
		['bruise', flaw.scrapper],
		['crab', feature.crab],
		['crab-leg', feature.crab],
		['rat', feature.rat],
	];
	for(let pair of elementIdAttributePairs) {
		let element = el.getElementById(pair[0]);
		if(element) {
			setSvgElVisibility(element, hasAttribute(pirate, pair[1]));
		}
	}
	let hiddenElementIdAttributePairs = [
		['hand', feature.hook],
		['left-hand', feature.leftHook],
		['left-boot', feature.pegLeg],
		['nose', feature.noNose],
		['teeth', feature.toothless],
		['eyebrows', flaw.scaredy],
	];
	for(let pair of hiddenElementIdAttributePairs) {
		setSvgElVisibility(el.getElementById(pair[0]), !hasAttribute(pirate, pair[1]));
	}
	let eyes = [ el.getElementById('eye'), el.getElementById('left-eye') ];
	let targetColor = hasAttribute(pirate, feature.blind) ? 'white' : 'black';
	for(let eyeEl of eyes) {
		eyeEl.style.fill = targetColor;
	}
	['head', 'arms', 'hand', 'left-hand', 'nose-skin'].forEach(id => el.getElementById(id).style.fill = pirate.colors[0]);
	let mouth = el.getElementById('full-mouth');
	mouth.style.transform = hasAttribute(pirate, flaw.scaredy) ? 'scale(1, -1) translateY(-85%)' : '';
	let topClothes = [ el.getElementById('shirt'), el.getElementById('bandanna') ];
	for(let topEl of topClothes) {
		topEl.style.fill = pirate.colors[2];
	}
	el.getElementById('pants').style.fill = pirate.colors[3];
	let hairIds = pirate.female ? femaleHairIds : maleHairIds;
	for(let hairId of hairIds) {
		el.getElementById(hairId).style.fill = pirate.colors[1];
	}
	let hairParts = pirate.female ? femaleHairParts : maleHairParts;
	for(let hairId of hairParts) {
		let shown = pirate.hair.parts.includes(hairId) &&
			!(hasAttribute(pirate, skill.swaggerin) && (hairId == 'hair-poof' || hairId == 'hair-curly-back'))
		;
		setSvgElVisibility(el.getElementById(hairId), shown);
	}
}

function updateTopBar() {
	if(typeof autoSave === 'undefined') {
		return;
	}
	document.getElementById('grog').textContent = grog;
	document.getElementById('booty').textContent = booty;
	document.getElementById('stash').style.display = stashedBooty ? 'inline' : 'none';
	document.getElementById('stashed-booty').textContent = stashedBooty;
	document.getElementById('devils-fist-icon').style.display = devilsFist ? 'inline' : 'none';
	document.getElementById('devils-fist-count').textContent = devilsFist > 1 ? devilsFist : '';
	let cap = getCaptain();
	document.getElementById('heading').textContent = (cap && cap.permanentFlags.has('whale_obsession')) ?
		'White Whale' : (headingToIsland ? 'Island' : 'Port')
	;
	let playButton = document.getElementById('time-play');
	let pauseButton = document.getElementById('time-pause');
	let stepButton = document.getElementById('time-step');
	let enabled = [];
	if(autoPlay) {
		enabled.push(pauseButton);
		pauseButton.style.display = 'inline-block';
		playButton.style.display = 'none';
	} else {
		enabled.push(playButton);
		if(paused) {
			enabled.push(stepButton);
		}
		pauseButton.style.display = 'none';
		playButton.style.display = 'inline-block';
	}
	[ playButton, pauseButton, stepButton ].forEach(button => {
		if(enabled.includes(button)) {
			button.style.opacity = 1;
			button.style.cursor = 'pointer';
		} else {
			button.style.opacity = .5;
			button.style.cursor = 'default';
		}
	});
}

async function addToLog(message) {
	let wait = LOG_SPEED;
	return new Promise(resolve => {
		let alreadyPaused = paused;
		if(!autoPlay && !alreadyPaused) {
			setPaused(true);
		}
		let logEl = document.getElementById('log');
		let entry = inflate(`<div style="background-color:moccasin; margin-top:.5rem; padding:.5rem;">${message}</div>`);
		logEl.appendChild(entry);
		entry.scrollIntoView({ behavior: "smooth", block: "end" });
		if(autoPlay) {
			window.setTimeout(() => {
				setPaused(false);
				resolve();
			}, wait);
		} else if(!alreadyPaused) {
			let listenerName = 'click';
			['time-step', 'time-play'].forEach(id => {
				let button = document.getElementById(id);
				let listener = event => {
					button.removeEventListener(listenerName, listener);
					setPaused(false);
					resolve();
				};
				button.addEventListener(listenerName, listener);
			});
		}
	});
}

function clearLog() {
	let logEl = document.getElementById('log');
	clear(logEl);
}

function switchInterface(interface) {
	let splashInterface = document.getElementById('splash-screen');
	let watermark = document.getElementById('watermark');
	let eventInterface = document.getElementById('chooser');
	let portInterface = document.getElementById('port-interface');
	let jobInterface = document.getElementById('job-interface');
	splashInterface.style.display = 'none';
	eventInterface.style.display = 'none';
	portInterface.style.display = 'none';
	jobInterface.style.display = 'none';
	watermark.style.display = 'none';
	switch(interface) {
		case 'splash':
			splashInterface.style.display = 'block';
			break;
		case 'event':
			eventInterface.style.display = 'flex';
			break;
		case 'job':
			jobInterface.style.display = 'flex';
			break;
		case 'port':
			portInterface.style.display = 'block';
			break;
		default:
			if(!mobileView) {
				watermark.style.display = 'block';
			}
			break;
	}
}

function updatePort() {
	let maxTradeAmount = getMaxTradeAmount();
	// initial setup
	if(!document.getElementById('grog-purchase-selector')) {
		let grogAmountSelector = prepareNumberSelect('grog-purchase-selector', 'Buy', purchaseGrog);
		document.getElementById('grog-purchase').after(grogAmountSelector);
	}
	let stashContainer = document.getElementById('stash-inputs');
	if(stashContainer.children.length == 0) {
		let select = prepareNumberSelect('stash-deposit', 'Deposit', depositBooty);
		select.style.marginTop = '1rem';
		stashContainer.appendChild(select);
		select = stashContainer.appendChild(prepareNumberSelect('stash-withdraw', 'Withdraw', withdrawBooty));
		select.style.marginTop = '1rem';
		stashContainer.appendChild(select);
	}
	// grog price
	let grogPrice = getGrogPrice();
	document.getElementById('grog-price').textContent = grogPrice.toString();
	// grog purchase selector
	let selector = document.getElementById('grog-purchase-selector');
	selector.blood4booty.limits.max = getMaxGrogPurchase();
	updateNumberSelect(selector);
	let devilsFistBuyButton = document.getElementById('devils-fist-buy-grog');
	devilsFistBuyButton.style.display = devilsFist ? 'inline' : 'none';
	devilsFistBuyButton.disabled = !canPurchaseGrogWithDevilsFist();
	// stash selectors
	selector = document.getElementById('stash-deposit');
	selector.blood4booty.limits.max = getMaxDeposit();
	updateNumberSelect(selector);
	selector = document.getElementById('stash-withdraw');
	selector.blood4booty.limits.max = stashedBooty;
	updateNumberSelect(selector);
	// buttons
	let recruitButton = document.getElementById('recruit-button');
	recruitButton.disabled = booty < 1 || grog < 1 || recruitButton.blood4booty?.inProgress;
	document.getElementById('win-button').disabled = !canWin();
}

async function doPortActions() {
	updatePort();
	switchInterface('port');
	if(AUTO) {
		withdrawBooty(stashedBooty);
		win();
		devilsFistForGrog();
		let targetCrewSize = Math.min(9, Math.floor((grog + booty) / 5));
		while(booty && grog && crew.length < targetCrewSize) {
			await recruitPirate();
		}
		let grogToPurchase = crew.length * 5 - grog;
		if(grogToPurchase > 0) {
			purchaseGrog(grogToPurchase);
		}
		depositBooty(booty);
		return new Promise(res => res());
	}
	let button = document.getElementById('finished-port-button');
	return new Promise((resolve, reject) => {
		let listenerName = 'click';
		let listener = event => {
			switchInterface();
			button.removeEventListener(listenerName, listener);
			resolve();
		};
		button.addEventListener(listenerName, listener);
	});
}

function updateEventText(prompt, description) {
	let promptEl = document.getElementById('prompt');
	promptEl.textContent = prompt;
	let descriptionEl = document.getElementById('description');
	descriptionEl.textContent = description;
	descriptionEl.style.display = description ? 'block' : 'none';
}

async function getNumberInput(prompt, description, confirmText, min, max) {
	switchInterface('event');
	updateOptions(null);
	updateEventText(prompt, description);
	return new Promise((resolve, reject) => {
		if(AUTO) {
			resolve(Math.floor(Math.random() * (max - min) + min));
			return;
		}
		let button = document.getElementById('continue-button');
		button.style.display = 'none';
		let optionHolder = document.getElementById('options');
		optionHolder.style.display = 'block';
		let select = prepareNumberSelect('event-number-chooser', confirmText, val => {
			switchInterface();
			button.style.display = 'inline';
			clear(optionHolder);
			resolve(val);
		});
		select.style.marginTop = '1rem';
		select.blood4booty.limits.max = max;
		select.blood4booty.limits.min = min;
		optionHolder.appendChild(select);
	});
}

function updateOptions(options, onSelected, singleSelect=false) {
	let optionHolder = document.getElementById('options');
	optionHolder.style.display = options == null ? 'none' : 'flex';
	clear(optionHolder);
	if(!options) {
		return;
	}
	for(let opt of options) {
		let optEl = inflate(`
			<div style="position:relative; cursor:pointer; align-self:center; margin-bottom:1rem;">
				<span ${opt.selected ? '' : 'class="selection-check"'} style="position:absolute; left:-1em; ${opt.selected ? '' : 'opacity:0;'}">✔</span>
				<span>${opt.text}</span>
			</div>
		`);
		optionHolder.appendChild(optEl);
		optEl.addEventListener('click', async () => {
			if(singleSelect) {
				options.forEach(o => o.selected = false);
			}
			opt.selected = !opt.selected;
			updateOptions(options, onSelected, singleSelect);
			if(onSelected) {
				onSelected();
			}
		});
	}
}

async function doAction(prompt, description, continueText, options, singleSelect, onSelected) {
	switchInterface('event');
	// basic text
	updateEventText(prompt, description);
	// button
	let buttonDisabled = onSelected ? !onSelected() : false;
	let button = document.getElementById('continue-button');
	button.textContent = continueText || 'Continue';
	button.disabled = buttonDisabled;
	// options
	updateOptions(options, onSelected ? (() => {
		let validSelection = onSelected();
		buttonDisabled = !validSelection;
		button.disabled = buttonDisabled;
	}) : null, singleSelect);
	// handle continue
	return new Promise((resolve, reject) => {
		let listenerName = 'click';
		let listener = event => {
			if(!buttonDisabled) {
				switchInterface();
				button.removeEventListener(listenerName, listener);
				resolve();
			}
		};
		button.addEventListener(listenerName, listener);
	});
}

async function getChoice(prompt, options, min=1, max=1) {
	let exactlyOne = max == 1 && min == 1;
	if(AUTO || (max == min && options.length == max)) {
		let number = min;
		if(AUTO) {
			number = randomInt(max+1-min)+min;
		}
		let selected = [];
		while(selected.length < number && selected.length < options.length) {
			selected.push(randomResult(options, selected));
		}
		let values = selected.map(opt => opt.value);
		return exactlyOne ? values[0] : values;
	}
	await doAction(
		prompt, '', 'Confirm',
		options, exactlyOne,
		() => {
			let selected = options.filter(opt => opt.selected);
			return selected.length <= max && selected.length >= min;
		},
	);
	let selected = options.filter(opt => opt.selected);
	let values = selected.map(opt => opt.value);
	return exactlyOne ? values[0] : values;
}

async function doJobAssignments() {
	updateJobLists();
	switchInterface('job');
	if(!AUTO) {
		let button = document.getElementById('finished-assignment-button');
		return new Promise((resolve, reject) => {
			let listenerName = 'click';
			let listener = event => {
				switchInterface();
				button.removeEventListener(listenerName, listener);
				resolve();
			};
			button.addEventListener(listenerName, listener);
		});
	}
	let scoreAssignments = assignments => {
		let captainMadnessPenalty = false;
		let score = 0;
		for(let i=0; i<3; i++) {
			let workers = filterWorkers(assignments[i]);
			score += Math.min(i == 0 ? 2 : 4, workers.length);
			if(i==0 && !workers.some(p => !p.captain)) {
				captainMadnessPenalty = true;
			}
		}
		if(captainMadnessPenalty) {
			score *= .8;
		}
		return score;
	};
	let bestScore = scoreAssignments([
		crew.filter(p => p.job == 'helm'),
		crew.filter(p => p.job == 'deck'),
		crew.filter(p => p.job == 'sails'),
	]);
	let bestAssignments = null;
	for(let i=0; i<30; i++) {
		let jobs = [
			{ id:'helm', target:1, assigned:[getCaptain()] },
			{ id:'deck', target:Math.floor((crew.length - 2) / 2) + 1, assigned:[] },
			{ id:'sails', target:Math.ceil((crew.length - 2) / 2) + 1, assigned:[] },
			{ id:'unassigned', target:1, assigned:[] },
		];
		let toAssign = crew.filter(p => !p.captain);
		while(toAssign.length) {
			let pirate = randomResult(toAssign);
			toAssign = toAssign.filter(p => p != pirate);
			let job = randomResult(jobs.filter(j => j.target > 0));
			job.assigned.push(pirate);
			job.target--;
		}
		let score = scoreAssignments(jobs.map(j => j.assigned));
		if(score >= bestScore) {
			bestScore = score;
			bestAssignments = jobs;
		}
	}
	if(bestAssignments) {
		for(let job of bestAssignments) {
			for(let pirate of job.assigned) {
				assignPirateToJob(pirate, job);
			}
		}
	}
}

function pirateToOption(pirate, selected = false) {
	return { value:pirate, text:getPirateName(pirate), selected:selected };
}

function pirateOptions(pirateGroup) {
	return pirateGroup.map(p => pirateToOption(p));
}

async function showEvent(event, type, arg) {
	let logPromise = addToLog(`${type}: ${event.name}`);
	if(!AUTO) {
		await doAction(event.name, event.description || '', event.continueText);
	}
	let result = await event.handler(arg);
	await logPromise;
	if(!AUTO && result && result.description) {
		await doAction(event.name, result.description, result.continueText);
	}
}

function newGame() {
	switchInterface();
	beginGame();
}

// initial UI setup
let jobs = [
	{
		id: 'unassigned',
		name: 'No Job',
	},
	{
		id: 'helm',
		name: 'Helm',
	},
	{
		id: 'deck',
		name: 'Deck',
	},
	{
		id: 'sails',
		name: 'Sails',
	},
];
let jobHolder = document.getElementById('job-area-holder');
jobs.forEach((job, i) => {
	let area = inflate(`
		<div style="display:flex; flex-direction:column; width:7rem; margin${i==1 ? ':0 .5rem' : (i==2 ? '-right:.5rem' : '0')};">
			<div>${job.name}</div>
			<div id="${job.id}-area" style="background-color:tan; flex-grow:1; overflow:auto; padding:.5rem;"></div>
			<div id="${job.id}-success-chance" style="opacity:.6; white-space:nowrap;">${i ? '' : 'Success chance:'}</div>
		</div>
	`);
	area.addEventListener('dragenter', ev => { ev.preventDefault(); return false; });
	area.addEventListener('dragover', ev => { ev.preventDefault(); return false; });
	area.addEventListener('drop', ev => {
		ev.preventDefault();
		let index = parseInt(ev.dataTransfer.getData('text/plain'));
		let pirate = crew[index];
		assignPirateToJob(pirate, job);
	});
	jobHolder.appendChild(area);
});
if(localStorage.getItem('blood4booty-saved-game')) {
	document.getElementById('load-button').style.display = 'inline';
}
let debugOpts = JSON.parse(localStorage.getItem('blood4booty-debug'));
if(debugOpts) {
	AUTO = debugOpts.auto;
	LOG_SPEED = debugOpts.speed;
	CHOOSE_ROLLS = debugOpts.chooseRolls;
	setDebug(true);
}

// the one UI global
mobileView = false;
function checkScreenSize() {
	let enteredMobileView = window.innerWidth < 700 || !('draggable' in document.createElement('div'));
	if(enteredMobileView != mobileView) {
		mobileView = enteredMobileView;
		onMobileModeUpdated();
	}
	document.getElementById('pirate-profile').style.flexDirection = mobileView ? 'column' : 'row';
}
window.onresize = checkScreenSize;
checkScreenSize();
function onMobileModeUpdated() {
	document.getElementById('page-body').style.display = mobileView ? 'block' : 'flex';
	document.getElementById('log-holder').style.width = mobileView ? '100%' : '20rem';
	let mainDisplay = document.getElementById('main');
	mainDisplay.style.position = mobileView ? 'absolute' : 'relative';
	mainDisplay.style.width = mobileView ? '100%' : 'none';
}

</script>
</body>
</html>
